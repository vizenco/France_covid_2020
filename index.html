<!DOCTYPE html>
<head>
  <meta charset="utf-8" />
  <script src="https://d3js.org/d3.v6.min.js"></script>

  <style>
    body {
      margin: 0;
      position: fixed;
      top: 0;
      right: 0;
      bottom: 0;
      left: 0;
    }
    .hidden {
      display: none;
    }
    .tooltip {
      color: #222;
      background-color: #fff;
      padding: 0.5em;
      text-shadow: #f5f5f5 0 1px 0;
      border-radius: 2px;
      opacity: 0.9;
      position: absolute;
    }
  </style>

  <div>
    <input id="slider" type="range" value="1" min="1" max="60" step="1" />
    <span id="day"></span>
  </div>
</head>

<body>
  <script>
    var list = [];
    init(list);
    console.log(list);
    var width = 700,
      height = 580;

    var svg = d3
      .select("body")
      .append("svg")
      .attr("width", width)
      .attr("height", height);

    var tooltip = d3
      .select("body")
      .append("div")
      .attr("class", "hidden tooltip");

    // On rajoute un groupe englobant toute la visualisation pour plus tard
    var g = svg.append("g");

    var projection = d3
      .geoConicConformal()
      .center([2.454071, 46.279229])
      .scale(2800);

    var path = d3.geoPath().projection(projection);

    d3.json("data/departements-fr.geojson").then(function (jsondata) {
      g.selectAll("path")
        .data(jsondata.features)
        .enter()
        .append("path")
        .attr("fill", "#ccc")
        .attr("d", path);
    });

    // initialisation des couleurs
    var colorize = d3
      .scaleQuantize()
      .range(["#fef0d9", "#fdcc8a", "#fc8d59", "#e34a33", "#b30000"]);
    //lecture csv
    d3.csv("data/covid-france-mars-avril.csv").then((data) => {
      colorize.domain([0, 1000]);
      //creation de la liste de jours
      //lecture json

      d3.json("data/departements-fr.geojson").then((json) => {
        var jour = "15/04/2020";
        console.log("données pour le " + jour);
        for (var i = 0; i < data.length; i++) {
          //Nom du departement
          if (data[i].jour == jour) {
            var dep = data[i].Département;

            var value = parseInt(data[i].hosp);
          }

          //Recherche de l'etat dans le GeoJSON
          for (var j = 0; j < json.features.length; j++) {
            var jsonDep = json.features[j].properties.nom;
            if (dep == jsonDep) {
              //On injecte la valeur de l'Etat dans le json
              json.features[j].properties.value = value;

              //Pas besoin de chercher plus loin
              break;
            }
          }
        }

        g.selectAll("path")
          .data(json.features, (data) => {
            return data;
          })
          .enter()
          .append("path")
          .attr("d", path)
          .style("fill", function (d) {
            //on prend la valeur recuperee plus haut
            var value = d.properties.value;

            if (value) {
              return colorize(value);
            } else {
              return "#ccc";
            }
          })
          .on("mouseover", function (event, d) {
            //on capture la position de la souris
            var pos = [event.pageX, event.pageY];
            tooltip
              .classed("hidden", false)
              .attr(
                "style",
                "left: " +
                  (pos[0] + 15) +
                  "px;" +
                  "top: " +
                  (pos[1] + 10) +
                  "px;"
              )
              .html(d.properties.nom + "<br/>" + "hosp: " + d.properties.value);
          })
          .on("mouseout", (event, d) => {
            tooltip.classed("hidden", true);
          });
      });
    });
    //d3.select("#slider").data(liste.length).enter().attr("max", data);

    d3.select("#day")
      .data(list)
      .enter()
      .html((d) => d);

    function init(list) {
      d3.csv("data/covid-france-mars-avril.csv").then((data) => {
        var list = [];
        for (var i = 0; i < data.length; i++) {
          if (list.indexOf(data[i].jour) == -1) {
            list.push(data[i].jour);
          }
        }
        list.sort(function (a, b) {
          var aa = a.split("/").reverse().join(),
            bb = b.split("/").reverse().join();
          return aa < bb ? -1 : aa > bb ? 1 : 0;
        });
      });
      return list;
    }
  </script>
</body>
